# Run Log - OAuth DB Diagnostics

Date: 2026-01-31

## Summary
- Updated OAuth DB diagnostics and error mapping.
- Adjusted OAuth upsert flow for idempotent user/account creation with org fallback.
- Hardened schedulePeriod ID sanitization.

## Commands Run

### Build
```
cd /workspace/KadryHR/backend-v2
npm run build
```
Result:
```
PASS (build succeeded)
```

### Tests
```
cd /workspace/KadryHR/backend-v2
npm test
```
Result:
```
FAIL src/shifts/shifts.service.spec.ts (expected EN message, got PL)
Other tests passed.
```

## Smoke Tests (curl) - to run against a running backend
> Note: requires backend-v2 to be running and accessible locally.

### Start -> 302 to Google
```
curl -I "http://localhost:3000/api/auth/oauth/google/start?redirect=/panel"
```
Expected:
- `HTTP/1.1 302 Found`
- `Location: https://accounts.google.com/...`

### Callback: state mismatch -> 400 oauth_state_mismatch
```
curl -i "http://localhost:3000/api/auth/oauth/google/callback?code=dummy&state=bad"
```
Expected:
- `HTTP/1.1 400 Bad Request`
- JSON contains `error: "oauth_state_mismatch"` and `requestId`

### Callback: DB error -> 409/500 with requestId
```
curl -i "http://localhost:3000/api/auth/oauth/google/callback?code=dummy&state=good" \
  -H "Cookie: oauth_state_google=good"
```
Expected:
- `HTTP/1.1 409 Conflict` for `oauth_user_conflict` / `oauth_fk_missing`
- `HTTP/1.1 404 Not Found` for `oauth_record_missing`
- `HTTP/1.1 500 Internal Server Error` for `oauth_db_failed`
- JSON contains `requestId`

## Sample Log Output (sanitized)
```
ERROR [OAuthService] OAuth user persistence failed {"requestId":"8668a14c-c1b5-460f-a472-46f6290a06f2","provider":"google","errorClass":"PrismaClientKnownRequestError","prismaCode":"P2002","meta":{"target":["email"]}}
ERROR [OAuthService] OAuth user persistence stack Error: PrismaClientKnownRequestError: ...
```
