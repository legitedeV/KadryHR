# Run log - OAuth DB upsert

## Scope
- Backend only (backend-v2)

## Summary
- Implemented transactional upsert for OAuth callback (user/oauthAccount/employee + default org).
- Added Prisma error logging with requestId and conflict handling.
- Added smoke test script with curl for OAuth callback.
- Guarded schedulePeriod findMany against undefined IDs.

## Commands executed
- npm run build (backend-v2)
- npm test (backend-v2) [fails: shifts.service.spec.ts expects English error string]

## Smoke tests (manual)
- Script: `backend-v2/scripts/smoke-oauth-callback.sh`

```bash
BASE_URL="http://localhost:3001"
PROVIDER="google"

curl -sS -D /tmp/oauth_headers.txt -o /dev/null \
  -c /tmp/oauth_cookies.txt \
  "$BASE_URL/api/auth/oauth/$PROVIDER/start?redirect=/panel"

CALLBACK_CODE="REPLACE_WITH_REAL_CODE"
CALLBACK_STATE="REPLACE_WITH_REAL_STATE"

for attempt in 1 2; do
  echo "\nAttempt ${attempt}:"
  curl -i -sS \
    -b /tmp/oauth_cookies.txt \
    "$BASE_URL/api/auth/oauth/$PROVIDER/callback?code=$CALLBACK_CODE&state=$CALLBACK_STATE"
done
```
